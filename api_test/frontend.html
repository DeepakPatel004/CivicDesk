<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicDesk API Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .card {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .btn {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #2563eb;
        }
        input, select {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #d1d5db;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }
        pre {
            background-color: #0d1117;
            padding: 1rem;
            border-radius: 0.375rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-white mb-2">CivicDesk API Testing Dashboard</h1>
        <p class="mb-8 text-gray-400">A simple interface to test all backend endpoints.</p>

        <!-- Global Info -->
        <div class="card p-4 rounded-lg mb-8">
            <h2 class="text-xl font-semibold text-white mb-2">Global Info</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="baseUrl" class="block text-sm font-medium mb-1">Base URL</label>
                    <input type="text" id="baseUrl" value="http://localhost:5000/api" class="w-full">
                </div>
                <div>
                    <label for="jwtToken" class="block text-sm font-medium mb-1">JWT Token (from Login/Verify)</label>
                    <input type="text" id="jwtToken" placeholder="Token will appear here after login" class="w-full">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Left Column: Auth -->
            <div class="flex flex-col gap-8">
                <!-- Signup -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">1. User Signup (Step 1)</h2>
                    <form id="signupForm" class="space-y-4">
                        <input type="text" id="signupName" placeholder="Name" required class="w-full">
                        <input type="email" id="signupEmail" placeholder="Email" required class="w-full">
                        <input type="password" id="signupPassword" placeholder="Password" required class="w-full">
                        <button type="submit" class="btn w-full">Sign Up</button>
                    </form>
                </div>

                <!-- Verify OTP -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">2. Verify OTP (Step 2)</h2>
                    <form id="verifyOtpForm" class="space-y-4">
                        <input type="email" id="verifyEmail" placeholder="Email (from signup)" required class="w-full">
                        <input type="text" id="verifyOtp" placeholder="6-Digit OTP from Email" required class="w-full">
                        <button type="submit" class="btn w-full">Verify OTP & Login</button>
                    </form>
                </div>

                <!-- Login -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">3. User Login (Existing User)</h2>
                    <form id="loginForm" class="space-y-4">
                        <input type="email" id="loginEmail" placeholder="Email" required class="w-full">
                        <input type="password" id="loginPassword" placeholder="Password" required class="w-full">
                        <button type="submit" class="btn w-full">Login</button>
                    </form>
                </div>
            </div>

            <!-- Right Column: Reports -->
            <div class="flex flex-col gap-8">
                <!-- Submit Report -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">4. Submit Report (Protected)</h2>
                    <p class="text-sm text-gray-400 mb-4">You must be logged in (have a JWT Token) to use this.</p>
                    <form id="submitReportForm" class="space-y-4">
                        <textarea id="reportDescription" placeholder="Description of the civic issue" required class="w-full h-24 bg-gray-700 border border-gray-600 rounded-md p-2"></textarea>
                        <input type="text" id="reportLocation" value='{"district": "Ranchi", "block": "Kanke", "locality": "Gandhi Nagar"}' required class="w-full">
                        <div>
                            <label for="reportPhoto" class="block text-sm font-medium mb-1">Upload Photo</label>
                            <input type="file" id="reportPhoto" required class="w-full">
                        </div>
                        <button type="submit" class="btn w-full">Submit Report</button>
                    </form>
                </div>

                <!-- Get User Reports -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">5. Get My Reports (Protected)</h2>
                     <p class="text-sm text-gray-400 mb-4">Fetches all reports submitted by the logged-in user.</p>
                    <button id="getUserReportsBtn" class="btn w-full">Fetch My Reports</button>
                </div>
            </div>

        </div>

        <!-- Response Area -->
        <div class="card p-4 rounded-lg mt-8">
            <h2 class="text-xl font-semibold text-white mb-2">API Response</h2>
            <pre id="responseArea" class="text-sm text-gray-300">{ "message": "Responses will appear here..." }</pre>
        </div>
    </div>

    <script>
        const baseUrlInput = document.getElementById('baseUrl');
        const jwtTokenInput = document.getElementById('jwtToken');
        const responseArea = document.getElementById('responseArea');

        // Helper function to display responses
        function displayResponse(data) {
            responseArea.textContent = JSON.stringify(data, null, 2);
        }

        // 1. Signup
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            try {
                const res = await fetch(`${baseUrlInput.value}/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                const data = await res.json();
                displayResponse(data);
                if(res.ok) {
                    document.getElementById('verifyEmail').value = email;
                }
            } catch (error) {
                displayResponse({ error: error.message });
            }
        });

        // 2. Verify OTP
        document.getElementById('verifyOtpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('verifyEmail').value;
            const otp = document.getElementById('verifyOtp').value;

            try {
                const res = await fetch(`${baseUrlInput.value}/auth/verify-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp })
                });
                const data = await res.json();
                displayResponse(data);
                if (data.token) {
                    jwtTokenInput.value = data.token;
                    sessionStorage.setItem('authToken', data.token);
                }
            } catch (error) {
                displayResponse({ error: error.message });
            }
        });

        // 3. Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const res = await fetch(`${baseUrlInput.value}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                displayResponse(data);
                if (data.token) {
                    jwtTokenInput.value = data.token;
                    sessionStorage.setItem('authToken', data.token);
                }
            } catch (error) {
                displayResponse({ error: error.message });
            }
        });

        // 4. Submit Report
        document.getElementById('submitReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = sessionStorage.getItem('authToken');
            if (!token) {
                displayResponse({ error: 'Not logged in. Please log in to get a JWT token.' });
                return;
            }

            const formData = new FormData();
            formData.append('description', document.getElementById('reportDescription').value);
            formData.append('location', document.getElementById('reportLocation').value);
            formData.append('photo', document.getElementById('reportPhoto').files[0]);

            try {
                const res = await fetch(`${baseUrlInput.value}/reports/submit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                const data = await res.json();
                displayResponse(data);
            } catch (error) {
                displayResponse({ error: error.message });
            }
        });

        // 5. Get My Reports
        document.getElementById('getUserReportsBtn').addEventListener('click', async () => {
            const token = sessionStorage.getItem('authToken');
            if (!token) {
                displayResponse({ error: 'Not logged in. Please log in to get a JWT token.' });
                return;
            }

            try {
                const res = await fetch(`${baseUrlInput.value}/reports/my-reports`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await res.json();
                displayResponse(data);
            } catch (error) {
                displayResponse({ error: error.message });
            }
        });
    </script>
</body>
</html>